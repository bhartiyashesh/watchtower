{% extends "base.html" %}

{% block title %}Dashboard - WatchTower{% endblock %}

{% block content %}
<h1>Dashboard</h1>

<div class="card-grid">
    <!-- Today's event count -->
    <div class="stat-card">
        <div class="stat-label">Events Today</div>
        <div class="stat-value">{{ today_count }}</div>
        <div class="stat-sub">Ring doorbell events since midnight UTC</div>
    </div>

    <!-- Lock status + controls -->
    <div class="stat-card">
        <div class="stat-label">Lock Status</div>
        <div style="margin-top: 0.5rem;">
            <span class="lock-badge" id="lock-badge">
                {% if lock_status and lock_status is mapping %}
                    {% set state = lock_status.get("lockState", "unknown") %}
                    {% if state == "locked" %}
                        <span class="lock-locked">Locked</span>
                    {% elif state == "unlocked" %}
                        <span class="lock-unlocked">Unlocked</span>
                    {% else %}
                        <span class="lock-unknown">{{ state | title }}</span>
                    {% endif %}
                {% else %}
                    <span class="lock-unknown">Unknown</span>
                {% endif %}
            </span>
        </div>
        <div class="lock-controls" style="margin-top: 0.75rem; display: flex; gap: 0.5rem;">
            <button id="btn-lock" class="lock-btn lock-btn-lock" onclick="sendLockCommand('lock')">Lock</button>
            <button id="btn-unlock" class="lock-btn lock-btn-unlock" onclick="sendLockCommand('unlock')">Unlock</button>
        </div>
        <div class="stat-sub" id="lock-msg" style="margin-top: 0.5rem;">SwitchBot smart lock</div>
    </div>

    <!-- Camera battery -->
    <div class="stat-card">
        <div class="stat-label">Camera Battery</div>
        <div class="stat-value" id="battery-value">—</div>
        <div id="battery-bar" style="margin-top: 0.4rem;"></div>
        <div class="stat-sub">Ring doorbell battery level</div>
    </div>

    {% if blink_configured %}
    <!-- Blink camera feed -->
    <div class="stat-card blink-card">
        <div class="stat-label">Blink Camera</div>

        <!-- 2FA verification form (shown when Blink needs verification) -->
        <div id="blink-2fa" style="margin-top: 0.5rem; {% if not blink_needs_2fa %}display: none;{% endif %}">
            <div style="
                width: 100%; aspect-ratio: 16/9; border-radius: 6px;
                background: rgba(255,255,255,0.04); display: flex;
                align-items: center; justify-content: center; flex-direction: column;
                gap: 0.75rem; padding: 1rem;
            ">
                <div style="color: rgba(255,255,255,0.5); font-size: 0.85rem; text-align: center;">
                    Blink sent a verification code to your email
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <input
                        id="blink-2fa-code"
                        type="text"
                        maxlength="6"
                        placeholder="Pin code"
                        style="
                            width: 8rem; padding: 0.4rem 0.6rem; border-radius: 6px;
                            border: 1px solid rgba(255,255,255,0.15);
                            background: rgba(255,255,255,0.06); color: #fff;
                            font-size: 1rem; text-align: center; letter-spacing: 0.2em;
                        "
                    >
                    <button class="lock-btn lock-btn-lock" onclick="submitBlink2fa()">Verify</button>
                </div>
                <div id="blink-2fa-msg" class="stat-sub"></div>
            </div>
        </div>

        <!-- Snapshot view (shown after successful auth) -->
        <div id="blink-snapshot-view" style="{% if blink_needs_2fa %}display: none;{% endif %}">
            <div class="blink-snapshot-wrap" style="margin-top: 0.5rem; position: relative;">
                <img
                    id="blink-snapshot"
                    alt="Blink camera snapshot"
                    style="width: 100%; border-radius: 6px; display: none;"
                >
                <div id="blink-placeholder" style="
                    width: 100%; aspect-ratio: 16/9; border-radius: 6px;
                    background: rgba(255,255,255,0.04); display: flex;
                    align-items: center; justify-content: center;
                    color: rgba(255,255,255,0.3); font-size: 0.85rem;
                ">Loading snapshot...</div>
            </div>
            <div style="margin-top: 0.5rem; display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                <button id="blink-btn-snapshot" class="lock-btn lock-btn-lock blink-mode-active" onclick="blinkSetMode('snapshot')">Snapshot</button>
                <button id="blink-btn-live" class="lock-btn lock-btn-unlock" onclick="blinkSetMode('live')">Live</button>
                <button id="blink-refresh" class="lock-btn lock-btn-lock" onclick="refreshBlink()">Refresh</button>
                <button id="blink-analyze" class="lock-btn lock-btn-analyze" onclick="analyzeBlink()">Analyze</button>
                <span id="blink-msg" class="stat-sub">Snapshot mode</span>
            </div>
            <div id="blink-detections" style="display: none; margin-top: 0.5rem;">
                <div id="blink-det-summary" style="
                    font-size: 0.85rem; color: rgba(255,255,255,0.7);
                    padding: 0.4rem 0.6rem; border-radius: 6px;
                    background: rgba(255,255,255,0.04);
                "></div>
                <div id="blink-det-tags" style="margin-top: 0.4rem; display: flex; gap: 0.3rem; flex-wrap: wrap;"></div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Most recent event -->
<h2>Most Recent Event</h2>
{% if last_event %}
    <div class="event-card">
        {% if last_event.thumbnail_path %}
            <img
                src="/dashboard/thumbnails/{{ last_event.thumbnail_path | basename }}"
                alt="Thumbnail for event at {{ last_event.recorded_at | humandate }}"
            >
        {% endif %}
        <div class="event-info">
            <div class="event-meta"><span class="utc-time" data-utc="{{ last_event.recorded_at }}"></span></div>
            <div class="event-title">
                {% if last_event.person_name %}
                    {{ last_event.person_name }}
                {% else %}
                    Unknown visitor
                {% endif %}
            </div>
            <div>
                <strong>Event type:</strong> {{ last_event.event_type }}
            </div>
            {% if last_event.door_action and last_event.door_action != "none" %}
                <div>
                    <strong>Door action:</strong> {{ last_event.door_action }}
                </div>
            {% endif %}
            {% if last_event.detections %}
                <div class="event-tags">
                    {% for det in last_event.detections %}
                        <span class="tag {% if det.label == 'person' %}tag-person{% endif %}">
                            {{ det.label }}
                        </span>
                    {% endfor %}
                </div>
            {% endif %}
        </div>
    </div>
{% else %}
    <div class="empty-state">
        No events recorded yet.
    </div>
{% endif %}

<a href="/dashboard/events" class="link-btn">View full event history</a>

<style>
    .lock-btn {
        padding: 0.4rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.15s, opacity 0.15s;
    }
    .lock-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
    }
    .lock-btn-lock {
        background: rgba(68, 204, 136, 0.2);
        color: var(--accent-green);
        border: 1px solid rgba(68, 204, 136, 0.3);
    }
    .lock-btn-lock:hover:not(:disabled) {
        background: rgba(68, 204, 136, 0.35);
    }
    .lock-btn-unlock {
        background: rgba(255, 136, 68, 0.2);
        color: var(--accent-orange);
        border: 1px solid rgba(255, 136, 68, 0.3);
    }
    .lock-btn-unlock:hover:not(:disabled) {
        background: rgba(255, 136, 68, 0.35);
    }
    .blink-mode-active {
        background: rgba(68, 204, 136, 0.4) !important;
        border-color: var(--accent-green) !important;
    }
    .lock-btn-analyze {
        background: rgba(186, 85, 211, 0.2);
        color: #bb88ee;
        border: 1px solid rgba(186, 85, 211, 0.3);
    }
    .lock-btn-analyze:hover:not(:disabled) {
        background: rgba(186, 85, 211, 0.35);
    }
    .det-tag {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    .det-tag-person  { background: rgba(68,204,136,0.2); color: #44cc88; }
    .det-tag-car     { background: rgba(100,149,237,0.2); color: #6495ed; }
    .det-tag-cat     { background: rgba(255,165,0,0.2); color: #ffa500; }
    .det-tag-dog     { background: rgba(255,136,68,0.2); color: #ff8844; }
    .det-tag-package { background: rgba(186,85,211,0.2); color: #ba55d3; }
</style>

<script>
// Convert UTC timestamps to local time
document.querySelectorAll('.utc-time').forEach(el => {
    const raw = el.dataset.utc;
    if (!raw) return;
    const utc = raw.includes('Z') ? raw : raw + 'Z';
    const dt = new Date(utc);
    el.textContent = dt.toLocaleString(undefined, {
        month: 'short', day: 'numeric', year: 'numeric',
        hour: 'numeric', minute: '2-digit'
    });
});

// Fetch battery level
fetch('/dashboard/api/battery', { credentials: 'include' })
    .then(r => r.json())
    .then(d => {
        const el = document.getElementById('battery-value');
        const bar = document.getElementById('battery-bar');
        if (d.battery !== null) {
            el.textContent = d.battery + '%';
            const color = d.battery > 50 ? 'var(--accent-green)' : d.battery > 20 ? 'var(--accent-yellow)' : 'var(--accent-orange)';
            el.style.color = color;
            bar.innerHTML = '<div style="background:rgba(255,255,255,0.06);border-radius:4px;height:6px;overflow:hidden"><div style="width:' + d.battery + '%;height:100%;background:' + color + ';border-radius:4px"></div></div>';
        } else {
            el.textContent = 'N/A';
        }
    })
    .catch(() => {});

// Blink 2FA submission
async function submitBlink2fa() {
    const input = document.getElementById('blink-2fa-code');
    const msg = document.getElementById('blink-2fa-msg');
    if (!input) return;

    const code = input.value.trim();
    if (!code) {
        msg.textContent = 'Please enter the verification code';
        return;
    }

    msg.textContent = 'Verifying...';

    try {
        const resp = await fetch('/dashboard/api/blink-2fa', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code: code }),
        });

        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'Verification failed');
        }

        // Success — hide 2FA form, show snapshot view
        document.getElementById('blink-2fa').style.display = 'none';
        document.getElementById('blink-snapshot-view').style.display = 'block';
        refreshBlink();
    } catch (e) {
        msg.textContent = e.message;
    }
}

// Allow Enter key to submit the Blink 2FA code
const blink2faInput = document.getElementById('blink-2fa-code');
if (blink2faInput) {
    blink2faInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') submitBlink2fa();
    });
}

// Blink camera — mode management (snapshot vs live)
let blinkMode = 'snapshot';

function blinkSetMode(mode) {
    const img = document.getElementById('blink-snapshot');
    const placeholder = document.getElementById('blink-placeholder');
    const msg = document.getElementById('blink-msg');
    const btnSnap = document.getElementById('blink-btn-snapshot');
    const btnLive = document.getElementById('blink-btn-live');
    const btnRefresh = document.getElementById('blink-refresh');
    if (!img) return;

    // Don't restart if already in this mode
    if (mode === blinkMode && mode === 'live' && img.src.includes('blink-live')) return;

    blinkMode = mode;

    // Update button active states
    btnSnap.classList.toggle('blink-mode-active', mode === 'snapshot');
    btnLive.classList.toggle('blink-mode-active', mode === 'live');

    if (mode === 'live') {
        // Stop any previous live stream before starting a new one
        fetch('/dashboard/api/blink-live-stop', { credentials: 'include' }).catch(() => {});

        // Set img src directly — browser natively renders MJPEG multipart stream
        if (placeholder) placeholder.style.display = 'none';
        img.style.display = 'block';
        img.src = '/dashboard/api/blink-live';
        msg.textContent = 'Live stream';
        btnRefresh.style.display = 'none';
    } else {
        // Switching back to snapshot: stop the live stream
        img.src = '';
        fetch('/dashboard/api/blink-live-stop', { credentials: 'include' }).catch(() => {});
        btnRefresh.style.display = '';
        msg.textContent = 'Snapshot mode';
        refreshBlink();
    }
}

// Blink camera snapshot fetch
async function refreshBlink() {
    const img = document.getElementById('blink-snapshot');
    const placeholder = document.getElementById('blink-placeholder');
    const btn = document.getElementById('blink-refresh');
    const msg = document.getElementById('blink-msg');
    if (!img || blinkMode !== 'snapshot') return;

    btn.disabled = true;
    msg.textContent = 'Fetching snapshot...';

    try {
        const resp = await fetch('/dashboard/api/blink-snapshot', { credentials: 'include' });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'Failed to fetch snapshot');
        }
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        img.onload = () => {
            if (placeholder) placeholder.style.display = 'none';
            img.style.display = 'block';
            URL.revokeObjectURL(url);
        };
        img.src = url;
        msg.textContent = 'Updated ' + new Date().toLocaleTimeString();
    } catch (e) {
        msg.textContent = 'Error: ' + e.message;
    } finally {
        btn.disabled = false;
    }
}

// Blink YOLO analysis
async function analyzeBlink() {
    const img = document.getElementById('blink-snapshot');
    const placeholder = document.getElementById('blink-placeholder');
    const btn = document.getElementById('blink-analyze');
    const msg = document.getElementById('blink-msg');
    const detsBox = document.getElementById('blink-detections');
    const detSummary = document.getElementById('blink-det-summary');
    const detTags = document.getElementById('blink-det-tags');
    if (!img) return;

    // Switch to snapshot mode if in live mode
    if (blinkMode === 'live') blinkSetMode('snapshot');

    btn.disabled = true;
    msg.textContent = 'Analyzing...';
    detsBox.style.display = 'none';

    try {
        const resp = await fetch('/dashboard/api/blink-analyze', { credentials: 'include' });
        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'Analysis failed');
        }
        const data = await resp.json();

        // Show annotated image
        if (placeholder) placeholder.style.display = 'none';
        img.style.display = 'block';
        img.src = 'data:image/jpeg;base64,' + data.image;

        // Show detections
        detSummary.textContent = data.summary;
        detTags.innerHTML = '';
        for (const det of data.detections) {
            const tag = document.createElement('span');
            tag.className = 'det-tag det-tag-' + det.label;
            tag.textContent = det.label + ' ' + Math.round(det.confidence * 100) + '%';
            detTags.appendChild(tag);
        }
        detsBox.style.display = 'block';
        msg.textContent = 'Analyzed ' + new Date().toLocaleTimeString();
    } catch (e) {
        msg.textContent = 'Error: ' + e.message;
    } finally {
        btn.disabled = false;
    }
}

// Auto-load Blink snapshot on page load (only if not waiting for 2FA)
if (document.getElementById('blink-snapshot') &&
    document.getElementById('blink-snapshot-view') &&
    document.getElementById('blink-snapshot-view').style.display !== 'none') {
    refreshBlink();
}

// Clean up live stream when navigating away
window.addEventListener('beforeunload', function() {
    if (blinkMode === 'live') {
        navigator.sendBeacon('/dashboard/api/blink-live-stop');
    }
});

// Lock / unlock controls
async function sendLockCommand(action) {
    const btnLock = document.getElementById('btn-lock');
    const btnUnlock = document.getElementById('btn-unlock');
    const badge = document.getElementById('lock-badge');
    const msg = document.getElementById('lock-msg');

    btnLock.disabled = true;
    btnUnlock.disabled = true;
    msg.textContent = action === 'lock' ? 'Locking...' : 'Unlocking...';

    try {
        const resp = await fetch('/dashboard/api/' + action, {
            method: 'POST',
            credentials: 'include'
        });

        if (!resp.ok) {
            const err = await resp.json().catch(() => ({}));
            throw new Error(err.detail || 'Command failed');
        }

        const data = await resp.json();
        if (data.status === 'locked') {
            badge.innerHTML = '<span class="lock-badge lock-locked">Locked</span>';
            msg.textContent = 'Door locked successfully';
        } else {
            badge.innerHTML = '<span class="lock-badge lock-unlocked">Unlocked</span>';
            msg.textContent = 'Door unlocked successfully';
        }
    } catch (e) {
        msg.textContent = 'Error: ' + e.message;
    } finally {
        btnLock.disabled = false;
        btnUnlock.disabled = false;
    }
}
</script>
{% endblock %}
