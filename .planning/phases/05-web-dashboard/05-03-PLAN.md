---
phase: 05-web-dashboard
plan: "03"
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - tests/test_dashboard.py
autonomous: true
requirements: [DASH-01, DASH-02, DASH-03, DASH-04, DASH-05, DASH-06, DASH-07]

must_haves:
  truths:
    - "All 7 DASH requirements have at least one passing test"
    - "Auth enforcement is tested: unauthenticated requests return 401"
    - "Event filtering by date range and object type is tested"
    - "Pagination is tested (page param, has_next logic)"
    - "Thumbnail serving with path traversal protection is tested"
    - "Summary widget data (today count, last event, lock status) is tested"
  artifacts:
    - path: "tests/test_dashboard.py"
      provides: "Complete dashboard test suite"
      min_lines: 100
  key_links:
    - from: "tests/test_dashboard.py"
      to: "dashboard/router.py"
      via: "TestClient with FastAPI test app including dashboard router"
      pattern: "TestClient"
    - from: "tests/test_dashboard.py"
      to: "event_store.py"
      via: "Real EventStore in temp directory for test isolation"
      pattern: "EventStore"
---

<objective>
Comprehensive test suite validating all DASH requirements for the web dashboard.

Purpose: Verify that auth enforcement, event feed, filters, pagination, thumbnail serving, and summary widget all work correctly. Uses a minimal test FastAPI app with the dashboard router (not the full app.py lifespan) to avoid needing real Ring/SwitchBot credentials.

Output: tests/test_dashboard.py with tests covering all 7 DASH requirements.
</objective>

<execution_context>
@.planning/phases/05-web-dashboard/05-RESEARCH.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-web-dashboard/05-01-SUMMARY.md
@.planning/phases/05-web-dashboard/05-02-SUMMARY.md
@dashboard/router.py
@event_store.py
@tests/test_event_store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard test suite with isolated test app</name>
  <files>tests/test_dashboard.py</files>
  <action>
Create tests/test_dashboard.py with a comprehensive test suite for all DASH requirements.

**Test infrastructure setup:**

1. Create a minimal test FastAPI app that includes ONLY the dashboard router (not the full app.py lifespan -- avoids needing Ring/SwitchBot credentials):
```python
from fastapi import FastAPI
from fastapi.testclient import TestClient
from dashboard.router import router, verify_credentials
from event_store import EventStore
from unittest.mock import MagicMock
import pytest
import pytest_asyncio
import tempfile
import os
import base64

test_app = FastAPI()
test_app.include_router(router)
```

2. Create a pytest-asyncio fixture `dashboard_client` that:
   - Creates a temp directory for DB and thumbnails
   - Initializes a real EventStore (not mocked -- tests actual SQL queries)
   - Sets test_app.state.store = store
   - Sets test_app.state.switchbot = MagicMock with get_lock_status returning {"lockState": "locked", "battery": 90}
   - Overrides verify_credentials dependency: `test_app.dependency_overrides[verify_credentials] = lambda: "testuser"`
   - Yields TestClient(test_app)
   - Cleans up: await store.close(), remove dependency override
   - IMPORTANT: Use @pytest.fixture (sync), not @pytest_asyncio.fixture, because TestClient is synchronous. Run async EventStore init inside an asyncio event loop using asyncio.get_event_loop().run_until_complete() or use a helper.

3. Create a helper function `auth_header(username, password)` that returns `{"Authorization": f"Basic {base64.b64encode(f'{username}:{password}'.encode()).decode()}"}` for auth tests.

4. Create a separate `no_auth_client` fixture that does NOT override verify_credentials (for testing 401 responses). This client tests against the same test_app but without the dependency override.

**Test cases (minimum 12 tests):**

**DASH-07: HTTP Basic Auth enforcement**
- `test_dashboard_home_requires_auth`: GET /dashboard/ without credentials -> 401, WWW-Authenticate header present
- `test_events_requires_auth`: GET /dashboard/events without credentials -> 401
- `test_thumbnails_requires_auth`: GET /dashboard/thumbnails/test.jpg without credentials -> 401

**DASH-01: Event history feed**
- `test_events_feed_renders_events`: Insert 3 events with detections via store.write_event(), GET /dashboard/events -> 200, response contains timestamps and detection labels
- `test_events_feed_empty`: GET /dashboard/events with no events in DB -> 200, shows empty state message

**DASH-02: Date range filtering**
- `test_filter_by_date_range_today`: Insert events with today's timestamp and one with old timestamp, GET /dashboard/events?date_range=today -> only today's events appear (check response content for today's timestamp, absence of old timestamp)

**DASH-03: Object type filtering**
- `test_filter_by_object_type`: Insert events where one has a "dog" detection and one has only "person", GET /dashboard/events?object_type=dog -> only the event with "dog" detection appears

**DASH-04: Summary widget**
- `test_dashboard_home_summary`: Insert 2 events today, GET /dashboard/ -> 200, response contains "2" (today_count), contains lock status text
- `test_dashboard_home_no_events`: GET /dashboard/ with empty DB -> 200, shows "0" for today_count

**DASH-05: Authenticated thumbnail serving**
- `test_thumbnail_served`: Create a test JPEG file in the temp thumbnails dir, GET /dashboard/thumbnails/{filename} -> 200, content-type is image/jpeg
- `test_thumbnail_not_found`: GET /dashboard/thumbnails/nonexistent.jpg -> 404
- `test_thumbnail_path_traversal_blocked`: GET /dashboard/thumbnails/../../.env -> 400 (path traversal blocked)
- `test_thumbnail_dotdot_blocked`: GET /dashboard/thumbnails/..%2F..%2F.env -> 400 or 404 (URL-encoded traversal blocked)

**DASH-06: Pagination**
- `test_pagination_page_1`: Insert 25 events, GET /dashboard/events?limit=20 -> response contains "Next" link, shows 20 events
- `test_pagination_page_2`: Insert 25 events, GET /dashboard/events?page=2&limit=20 -> response contains "Previous" link, shows 5 events, no "Next" link

**Test event creation helper:**
Create a helper async function `insert_test_event(store, recorded_at, person_name, detections)` that calls store.write_event() with reasonable defaults. Use this in all tests that need data.

Use `datetime.datetime.utcnow().isoformat()` for "today" timestamps and `"2020-01-01T12:00:00"` for "old" timestamps in filter tests.

CRITICAL: The test app must NOT import or trigger app.py's lifespan (which requires Ring/SwitchBot auth). Tests use their own minimal FastAPI app with just the dashboard router.

Mark all tests that use the async EventStore fixture with @pytest.mark.asyncio where needed. Since TestClient is synchronous, the fixture should handle the async EventStore lifecycle carefully -- use an event loop to run async setup/teardown.
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && python -m pytest tests/test_dashboard.py -v --tb=short 2>&1 | tail -30</automated>
  </verify>
  <done>tests/test_dashboard.py has 12+ tests covering all 7 DASH requirements: auth enforcement (3 tests), event feed (2), date filtering (1), object filtering (1), summary widget (2), thumbnail serving (3+), pagination (2). All tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite to confirm no regressions</name>
  <files></files>
  <action>
Run the complete test suite (all test files) to verify that:
1. All new dashboard tests pass
2. All 52 existing tests still pass (no regressions from dashboard code changes)
3. No import errors from the dashboard package

Command: `python -m pytest tests/ -v --tb=short`

If any test fails:
- If a dashboard test fails: fix the test or the dashboard code, then re-run
- If an existing test fails: the regression is caused by changes to event_store.py, config.py, or app.py -- fix the change that broke it while preserving the new functionality

Expected result: 64+ tests pass (52 existing + 12+ new dashboard tests).
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && python -m pytest tests/ -v --tb=short 2>&1 | tail -5</automated>
  </verify>
  <done>Full test suite passes with 64+ tests (52 existing + 12+ new). No regressions. All DASH requirements validated by at least one test.</done>
</task>

</tasks>

<verification>
Complete validation:
1. `python -m pytest tests/test_dashboard.py -v` -- all dashboard tests pass
2. `python -m pytest tests/ -v` -- full suite passes (no regressions)
3. Each DASH requirement has at least one test asserting its behavior
4. Auth tests use a client WITHOUT dependency override to confirm real 401 behavior
5. Filter and pagination tests use real EventStore queries (not mocked SQL)
</verification>

<success_criteria>
- 12+ dashboard tests covering all 7 DASH requirements
- All tests pass including 52 existing tests (64+ total)
- Auth enforcement tested with unauthenticated client (real 401, not mocked)
- Filters tested with real EventStore SQL queries against populated test DB
- Thumbnail path traversal attack is blocked and tested
- Pagination tested with enough events to span multiple pages
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-dashboard/05-03-SUMMARY.md`
</output>
