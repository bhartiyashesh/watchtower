---
phase: 05-web-dashboard
plan: "02"
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - dashboard/__init__.py
  - dashboard/router.py
  - dashboard/templates/base.html
  - dashboard/templates/events.html
  - dashboard/templates/dashboard.html
  - app.py
autonomous: true
requirements: [DASH-01, DASH-02, DASH-03, DASH-04, DASH-05, DASH-07]

must_haves:
  truths:
    - "User can open /dashboard/ and see a summary widget with today's event count, last event, and lock status"
    - "User can open /dashboard/events and see a scrollable event feed with thumbnail, timestamp, detected objects, and person name"
    - "User can filter events by date range (today, 7d, 30d) and object type (person, dog, cat, car, package)"
    - "Accessing any /dashboard/ URL without Basic Auth credentials returns 401"
    - "Thumbnails at /dashboard/thumbnails/{filename} are served via FileResponse with auth enforced"
    - "Event feed uses server-side pagination with next/prev navigation"
  artifacts:
    - path: "dashboard/__init__.py"
      provides: "Package marker"
    - path: "dashboard/router.py"
      provides: "APIRouter with auth dependency, dashboard home, events feed, thumbnail serving"
      exports: ["router", "verify_credentials"]
    - path: "dashboard/templates/base.html"
      provides: "Shared HTML layout with nav and page structure"
      contains: "block content"
    - path: "dashboard/templates/events.html"
      provides: "Event history feed with filter form and pagination"
      contains: "date_range"
    - path: "dashboard/templates/dashboard.html"
      provides: "Summary widget with today count, last event, lock status"
      contains: "today_count"
    - path: "app.py"
      provides: "Dashboard router included via app.include_router()"
      contains: "include_router"
  key_links:
    - from: "dashboard/router.py"
      to: "event_store.py"
      via: "request.app.state.store for EventStore access"
      pattern: "request\\.app\\.state\\.store"
    - from: "dashboard/router.py"
      to: "switchbot_client.py"
      via: "request.app.state.switchbot via run_in_executor"
      pattern: "run_in_executor.*get_lock_status"
    - from: "dashboard/router.py"
      to: "config.py"
      via: "Config.DASHBOARD_USERNAME and Config.DASHBOARD_PASSWORD for auth"
      pattern: "Config\\.DASHBOARD_PASSWORD"
    - from: "app.py"
      to: "dashboard/router.py"
      via: "app.include_router(dashboard_router)"
      pattern: "include_router"
    - from: "dashboard/templates/events.html"
      to: "dashboard/router.py"
      via: "Template renders events list with thumbnail URLs pointing to /dashboard/thumbnails/"
      pattern: "/dashboard/thumbnails/"
---

<objective>
Build the complete dashboard: APIRouter with HTTP Basic Auth, Jinja2 templates for event feed and summary widget, and authenticated FileResponse thumbnail serving.

Purpose: This plan delivers the full user-facing web dashboard. The homeowner can view event history, filter by date/object type, see today's summary, and browse thumbnails -- all behind HTTP Basic Auth. This closes DASH-01 through DASH-05 and DASH-07.

Output: dashboard/ package (router.py, 3 templates), app.py updated to include the router.
</objective>

<execution_context>
@.planning/phases/05-web-dashboard/05-RESEARCH.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/05-web-dashboard/05-01-SUMMARY.md
@event_store.py
@config.py
@app.py
@switchbot_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dashboard package with router, auth, and all routes</name>
  <files>dashboard/__init__.py, dashboard/router.py</files>
  <action>
Create the `dashboard/` directory with `__init__.py` (empty) and `router.py`.

**dashboard/__init__.py:** Empty file (package marker).

**dashboard/router.py:** Full implementation:

1. **Imports:** asyncio, secrets, pathlib.Path, typing.Annotated, fastapi (APIRouter, Depends, HTTPException, Request, status), fastapi.responses (FileResponse, HTMLResponse), fastapi.security (HTTPBasic, HTTPBasicCredentials), fastapi.templating (Jinja2Templates), config.Config

2. **Auth dependency (verify_credentials):**
   - Use HTTPBasic() security scheme
   - Compare credentials.username and credentials.password against Config.DASHBOARD_USERNAME and Config.DASHBOARD_PASSWORD using secrets.compare_digest() on utf8-encoded bytes
   - On mismatch: raise HTTPException 401 with headers={"WWW-Authenticate": "Basic"}
   - Return credentials.username on success

3. **Router setup:**
   - `router = APIRouter(prefix="/dashboard", dependencies=[Depends(verify_credentials)])`
   - Router-level dependency ensures ALL routes (including thumbnails) require auth
   - `templates = Jinja2Templates(directory="dashboard/templates")`

4. **Route: GET /dashboard/ (dashboard home / summary widget) -> DASH-04**
   - Access store via request.app.state.store
   - Access switchbot via request.app.state.switchbot
   - Call `await store.get_today_event_count()` for today's count
   - Call `await store.get_recent_events(limit=1)` for last event
   - Call switchbot.get_lock_status() via `await asyncio.get_event_loop().run_in_executor(None, switchbot.get_lock_status)` -- MUST use executor because get_lock_status() uses synchronous requests.get()
   - Wrap switchbot call in try/except to handle None or errors gracefully (show "Unknown" if it fails)
   - Render dashboard.html with context: today_count, last_event, lock_status

5. **Route: GET /dashboard/events (event feed with filters + pagination) -> DASH-01, DASH-02, DASH-03, DASH-06**
   - Query params: page (int, default 1), limit (int, default 20), date_range (str, default "all"), object_type (str, default "all")
   - Calculate offset = (page - 1) * limit
   - Call `await store.get_filtered_events(limit=limit, offset=offset, date_range=date_range, object_type=object_type)`
   - Determine has_next = len(events) == limit (avoids COUNT(*) full table scan)
   - Render events.html with context: events, page, limit, date_range, object_type, has_next

6. **Route: GET /dashboard/thumbnails/{filename} (authenticated file serving) -> DASH-05**
   - Block path traversal: if "/" in filename or ".." in filename, raise HTTPException 400
   - Construct path: Path(Config.THUMBNAILS_DIR) / filename
   - If path doesn't exist or isn't a file, raise HTTPException 404
   - Return FileResponse(str(path), media_type="image/jpeg")
   - Auth is enforced by router-level dependency -- no additional auth check needed here

CRITICAL anti-patterns to avoid:
- Do NOT use StaticFiles for thumbnails (bypasses auth) -- LOCKED DECISION
- Do NOT use string equality (==) for credential comparison -- use secrets.compare_digest()
- Do NOT call switchbot.get_lock_status() directly in async route -- MUST use run_in_executor
- Do NOT interpolate user input into SQL (handled by EventStore, but route must not add its own queries)
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && python -c "
import ast
# Check router.py parses
tree = ast.parse(open('dashboard/router.py').read())
# Check for key exports
src = open('dashboard/router.py').read()
assert 'verify_credentials' in src, 'verify_credentials function missing'
assert 'secrets.compare_digest' in src, 'Must use secrets.compare_digest for timing-safe comparison'
assert 'APIRouter' in src, 'APIRouter not used'
assert 'FileResponse' in src, 'FileResponse not used for thumbnails'
assert 'run_in_executor' in src, 'Must use run_in_executor for switchbot.get_lock_status()'
assert 'HTTPBasic' in src, 'HTTPBasic security scheme not used'
assert '\"..\"' in src or \"'..'\" in src, 'Path traversal check missing'
print('OK: router.py structure verified')
# Check __init__.py exists
import os
assert os.path.exists('dashboard/__init__.py'), '__init__.py missing'
print('OK: dashboard package complete')
"</automated>
  </verify>
  <done>dashboard/router.py has verify_credentials with secrets.compare_digest, router-level auth dependency, three routes (home summary, event feed with filters/pagination, thumbnail FileResponse), and path traversal protection</done>
</task>

<task type="auto">
  <name>Task 2: Create Jinja2 templates and mount router in app.py</name>
  <files>dashboard/templates/base.html, dashboard/templates/events.html, dashboard/templates/dashboard.html, app.py</files>
  <action>
Create `dashboard/templates/` directory and three HTML templates, then mount the router in app.py.

**dashboard/templates/base.html:**
- Standard HTML5 document with meta viewport for mobile
- Simple CSS (inline in a style tag -- no external CSS files needed for home server):
  - Clean sans-serif font, max-width container, responsive
  - Card styling for event items (border, padding, shadow)
  - Navigation bar with links to /dashboard/ and /dashboard/events
  - Thumbnail images sized to max 200px width
- Jinja2 blocks: {% block title %}, {% block content %}
- Auto-escaping is ON by default in Jinja2 (critical for XSS prevention on person names and labels)

**dashboard/templates/dashboard.html:**
- Extends base.html
- Title: "Dashboard - Smart Lock"
- Summary widget section showing:
  - Today's event count: {{ today_count }}
  - Last event card (if last_event exists): thumbnail image (src="/dashboard/thumbnails/{{ last_event.thumbnail_path | replace('thumbnails/', '') }}" -- must strip the "thumbnails/" prefix because save_thumbnail returns "thumbnails/filename.jpg" but the route expects just "filename"), timestamp {{ last_event.recorded_at }}, person name {{ last_event.person_name or "Unknown" }}
  - Lock status: display lock_status.get("lockState", "Unknown") if lock_status is a dict, else "Unknown"
- Link to full event history: /dashboard/events

CRITICAL: Thumbnail path handling -- EventStore.save_thumbnail() stores paths like "thumbnails/2026-02-25T10-30-00.jpg". The template must extract just the filename for the /dashboard/thumbnails/ URL. Use a Jinja2 filter or simple string replacement. Recommended approach: In the template, use `{{ event.thumbnail_path.split('/')[-1] }}` or add a custom basename filter in router.py: `templates.env.filters["basename"] = lambda p: p.split("/")[-1] if p else ""`.

**dashboard/templates/events.html:**
- Extends base.html
- Title: "Event History - Smart Lock"
- Filter form (method="GET", action="/dashboard/events"):
  - Date range select: All, Today, Last 7 Days, Last 30 Days (values: all, today, 7d, 30d) -- pre-select current date_range value
  - Object type select: All, Person, Dog, Cat, Car, Package (values: all, person, dog, cat, car, package) -- pre-select current object_type value
  - Submit button: "Filter"
- Event list: loop over events
  - Each event card shows:
    - Thumbnail image (if thumbnail_path exists): src="/dashboard/thumbnails/{{ event.thumbnail_path.split('/')[-1] }}"
    - Timestamp: {{ event.recorded_at }}
    - Event type: {{ event.event_type }}
    - Person: {{ event.person_name or "No match" }}
    - Detected objects: comma-joined list of detection labels from event.detections
    - Door action: {{ event.door_action }}
  - Empty state message when no events match filters
- Pagination controls:
  - Previous page link (if page > 1): /dashboard/events?page={{ page - 1 }}&limit={{ limit }}&date_range={{ date_range }}&object_type={{ object_type }}
  - Next page link (if has_next): /dashboard/events?page={{ page + 1 }}&limit={{ limit }}&date_range={{ date_range }}&object_type={{ object_type }}
  - Show current page number

**app.py changes:**
1. Add import at the top (after existing imports, before logging setup): `from dashboard.router import router as dashboard_router`
2. After the line `app = FastAPI(lifespan=lifespan, title="Smart Lock System")`, add: `app.include_router(dashboard_router)`
3. Do NOT modify any other part of app.py

Add a Jinja2 basename filter in router.py for thumbnail path extraction:
```python
templates.env.filters["basename"] = lambda path: path.split("/")[-1] if path else ""
```
This allows templates to use `{{ event.thumbnail_path | basename }}` instead of the split approach.
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && python -c "
import os
# Check all template files exist
templates = [
    'dashboard/templates/base.html',
    'dashboard/templates/events.html',
    'dashboard/templates/dashboard.html',
]
for t in templates:
    assert os.path.exists(t), f'Template missing: {t}'
    content = open(t).read()
    assert len(content) > 50, f'Template too small: {t}'
print('OK: all 3 templates exist')

# Check app.py includes the router
src = open('app.py').read()
assert 'include_router' in src, 'app.py must include_router(dashboard_router)'
assert 'dashboard_router' in src or 'dashboard.router' in src, 'dashboard router import missing from app.py'
print('OK: app.py includes dashboard router')

# Check events.html has filter form and pagination
events_html = open('dashboard/templates/events.html').read()
assert 'date_range' in events_html, 'events.html missing date_range filter'
assert 'object_type' in events_html, 'events.html missing object_type filter'
assert 'page' in events_html, 'events.html missing pagination'
print('OK: events.html has filters and pagination')

# Check dashboard.html has summary widget
dash_html = open('dashboard/templates/dashboard.html').read()
assert 'today_count' in dash_html, 'dashboard.html missing today_count'
assert 'lock_status' in dash_html or 'lock' in dash_html.lower(), 'dashboard.html missing lock status'
print('OK: dashboard.html has summary widget')
"</automated>
  </verify>
  <done>Three Jinja2 templates render the dashboard (summary widget, event feed with filters/pagination), app.py mounts the dashboard router, thumbnails use basename filter for correct path extraction</done>
</task>

</tasks>

<verification>
Full dashboard is accessible and functional:
1. All routes exist: /dashboard/, /dashboard/events, /dashboard/thumbnails/{filename}
2. Auth is enforced on all routes (router-level dependency)
3. Templates render with Jinja2 auto-escaping (XSS protection)
4. Filters work via GET query parameters
5. Pagination uses next/prev with has_next heuristic
6. Thumbnails served via FileResponse with path traversal protection
7. Lock status fetched via run_in_executor (non-blocking)
8. Existing tests still pass: `python -m pytest tests/ -x -q`
</verification>

<success_criteria>
- GET /dashboard/ renders summary widget with today_count, last_event, lock_status
- GET /dashboard/events renders event feed with filter form and pagination
- GET /dashboard/events?date_range=today&object_type=person filters correctly
- GET /dashboard/thumbnails/{filename} returns JPEG with auth enforced
- Any /dashboard/ URL without credentials returns 401 with WWW-Authenticate header
- No StaticFiles used anywhere (LOCKED DECISION)
- secrets.compare_digest used for credential comparison
</success_criteria>

<output>
After completion, create `.planning/phases/05-web-dashboard/05-02-SUMMARY.md`
</output>
