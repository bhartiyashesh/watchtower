---
phase: 01-data-foundation
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - tests/test_event_store.py
  - tests/__init__.py
autonomous: true
requirements: [DATA-01, DATA-02, DATA-03, DATA-04, DATA-05, DATA-06]

must_haves:
  truths:
    - "Concurrent read and write operations complete without 'database is locked' errors"
    - "A stranger event (person_name=None) is stored and distinguishable from a recognized person event"
    - "Multiple detections per event are stored and retrievable in correct order"
    - "Thumbnail save failure does not prevent event storage"
    - "Event with no detections writes successfully (NULL detections case)"
    - "Face distance and face confidence are stored as separate values"
  artifacts:
    - path: "tests/test_event_store.py"
      provides: "Comprehensive EventStore test suite"
      min_lines: 100
    - path: "tests/__init__.py"
      provides: "Python package marker for tests directory"
  key_links:
    - from: "tests/test_event_store.py"
      to: "event_store.py"
      via: "imports EventStore class"
      pattern: "from event_store import EventStore"
---

<objective>
Validate the EventStore module with a comprehensive test suite covering all DATA requirements. Critically, this tests concurrent read/write access (DATA-05) which is the highest-risk behavior -- the WAL mode + busy_timeout configuration must be proven to work under simultaneous load. Also validates edge cases: stranger events, empty detections, thumbnail failures, and face distance vs confidence distinction.

Purpose: Prove that the data foundation is reliable before any other phase builds on it. Concurrent access failures would cascade through every downstream phase.

Output: `tests/test_event_store.py` with automated tests that run in under 30 seconds and validate all 6 DATA requirements.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-data-foundation/01-RESEARCH.md
@.planning/phases/01-data-foundation/01-01-SUMMARY.md
@event_store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create comprehensive EventStore test suite</name>
  <files>tests/__init__.py, tests/test_event_store.py</files>
  <action>
1. Create `tests/__init__.py` as an empty file (Python package marker).

2. Create `tests/test_event_store.py` with the following test cases. Use `pytest` with `pytest-asyncio` for async test support. Each test creates a fresh EventStore in a temporary directory (using `tempfile.TemporaryDirectory`) so tests are fully isolated.

**Install test dependencies first:** `pip install pytest pytest-asyncio`

**Fixture:**
```python
@pytest.fixture
async def store():
    """Yields an initialized EventStore in a temp directory, cleans up after."""
    with tempfile.TemporaryDirectory() as td:
        s = EventStore(
            db_path=os.path.join(td, "test.db"),
            thumbnails_dir=os.path.join(td, "thumbnails"),
        )
        await s.initialize()
        yield s
        await s.close()
```

**Test cases (one function per test):**

a. `test_wal_mode_active(store)` -- DATA-05
   - Execute `PRAGMA journal_mode` on the connection.
   - Assert result is `"wal"`.

b. `test_write_and_read_motion_event(store)` -- DATA-01
   - Write event with: `camera_id="front_door"`, `recorded_at="2026-02-25T10:30:00"`, `event_type="motion"`, `recording_id="rec_001"`.
   - Read event back via `get_event(event_id)`.
   - Assert all fields match: camera_id, recorded_at, event_type, recording_id.
   - Assert `created_at` is not None.

c. `test_write_and_read_detections(store)` -- DATA-02
   - Write event with 3 detections: `[{"label": "person", "confidence": 0.95, "bbox_x1": 10, "bbox_y1": 20, "bbox_x2": 100, "bbox_y2": 200}, {"label": "dog", "confidence": 0.87}, {"label": "car", "confidence": 0.72, "bbox_x1": 200, "bbox_y1": 50, "bbox_x2": 400, "bbox_y2": 300}]`.
   - Read event back, assert `len(event["detections"]) == 3`.
   - Assert labels are ["person", "dog", "car"] (order preserved from insert).
   - Assert person detection has all bbox fields populated.
   - Assert dog detection has bbox fields as None (not provided).

d. `test_thumbnail_save_and_path_storage(store)` -- DATA-03
   - Create a small test JPEG in memory using Pillow: `Image.new("RGB", (100, 100), color="red")`, save to BytesIO as JPEG, get bytes.
   - Call `store.save_thumbnail(jpeg_bytes, "2026-02-25T10-30-00")`.
   - Assert returned path is a string containing "thumbnails/" and ending with ".jpg".
   - Assert the file actually exists on disk at `store.thumbnails_dir / filename`.
   - Assert file size > 0.
   - Write event with the thumbnail_path, read back, assert thumbnail_path matches.

e. `test_unlock_action_logged(store)` -- DATA-04
   - Write event with: `person_name="alice"`, `face_confidence=0.85`, `unlock_granted=True`, `door_action="unlocked"`.
   - Read back, assert `unlock_granted == 1`, `door_action == "unlocked"`, `person_name == "alice"`, `face_confidence == 0.85`.

f. `test_face_recognition_results(store)` -- DATA-06
   - Write event with: `person_name="bob"`, `face_distance=0.32`, `face_confidence=0.68`.
   - Read back, assert `face_distance == 0.32`, `face_confidence == 0.68`, `person_name == "bob"`.
   - Verify distance and confidence are separate columns with distinct values.

g. `test_stranger_event(store)` -- DATA-01, DATA-06
   - Write event with: `person_name=None`, `face_confidence=None`, `face_distance=None`, `unlock_granted=False`.
   - Read back, assert `person_name is None`, `face_confidence is None`, `unlock_granted == 0`.

h. `test_event_with_no_detections(store)` -- DATA-01
   - Write event with `detections=None`.
   - Read back, assert `event["detections"] == []` (empty list, not None).

i. `test_concurrent_read_write(store)` -- DATA-05
   - This is the critical concurrent access test.
   - Define an async `writer()` that writes 20 events with `asyncio.sleep(0.01)` between each.
   - Define an async `reader()` that calls `get_recent_events(limit=5)` 20 times with `asyncio.sleep(0.01)` between each.
   - Run both concurrently with `asyncio.gather(writer(), reader())`.
   - Assert no exceptions were raised (no "database is locked" errors).
   - After both complete, assert total events in DB is 20 via `get_recent_events(limit=100)`.

j. `test_thumbnail_save_failure_returns_none(store)` -- DATA-03
   - Call `store.save_thumbnail(b"not_a_valid_jpeg", "2026-02-25T11-00-00")`.
   - Assert return value is None (graceful failure, no exception raised).

k. `test_get_recent_events_pagination(store)` -- supports DASH-06 readiness
   - Write 10 events with sequential timestamps.
   - Call `get_recent_events(limit=3, offset=0)` -- assert 3 events returned, most recent first.
   - Call `get_recent_events(limit=3, offset=3)` -- assert 3 events returned, next batch.
   - Call `get_recent_events(limit=3, offset=9)` -- assert 1 event returned (last one).

l. `test_ding_event_type(store)` -- DATA-01
   - Write event with `event_type="ding"`.
   - Read back, assert `event_type == "ding"`.

All tests must use `@pytest.mark.asyncio` decorator and the `store` fixture.
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && source venv/bin/activate && python -m pytest tests/test_event_store.py -v --tb=short 2>&1 | tail -30</automated>
  </verify>
  <done>All 12 test cases pass. Concurrent read/write test completes without "database is locked" errors. Stranger events, empty detections, thumbnail failures, and pagination all handled correctly. Every DATA requirement (DATA-01 through DATA-06) has at least one dedicated test.</done>
</task>

<task type="auto">
  <name>Task 2: Verify WAL mode and run full integration smoke test</name>
  <files>No new files -- validation only</files>
  <action>
Run the following validation checks to confirm the entire data foundation is solid:

1. **WAL mode file verification:** After running the test suite, check that the test creates the WAL and SHM sidecar files (proves WAL mode is functioning at the filesystem level, not just returning "wal" from PRAGMA):
   ```python
   # Create a persistent DB, write events, verify .db-wal and .db-shm exist
   ```

2. **Schema introspection:** Run `sqlite3 test.db ".schema"` on a generated test database and verify all 3 tables and 5 indexes exist with the correct column definitions.

3. **Foreign key enforcement:** Write a detection with a non-existent event_id and confirm it raises an `sqlite3.IntegrityError` (proves `PRAGMA foreign_keys=ON` is working).

4. **Persons table verification:** Insert a person into the persons table, attempt to insert a duplicate name, confirm UNIQUE constraint raises an error.

5. **Run the full test suite one final time** to ensure all tests still pass after any adjustments.

Add these as additional test functions in `tests/test_event_store.py`:
- `test_foreign_key_enforcement(store)` -- insert detection with fake event_id, assert IntegrityError
- `test_persons_table_unique_constraint(store)` -- insert same person name twice, assert IntegrityError
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && source venv/bin/activate && python -m pytest tests/test_event_store.py -v --tb=short 2>&1 | tail -40</automated>
  </verify>
  <done>All tests pass including foreign key enforcement and unique constraint tests. WAL mode confirmed active at both PRAGMA and filesystem level. Schema has all 3 tables and 5 indexes. The data foundation is proven reliable for concurrent access.</done>
</task>

</tasks>

<verification>
1. `pytest tests/test_event_store.py -v` shows all tests passing (14 tests)
2. Concurrent read/write test completes without "database is locked" errors
3. Foreign key enforcement confirmed (can't insert orphan detections)
4. Persons table UNIQUE constraint confirmed
5. WAL mode verified at PRAGMA level
6. Thumbnail save/fail behavior correct
7. Pagination works (limit/offset)
</verification>

<success_criteria>
- All 14 test functions pass in under 30 seconds
- Zero "database is locked" errors during concurrent access test
- 100% of DATA-01 through DATA-06 requirements covered by at least one test
- Foreign key and unique constraints enforced
- Test suite is self-contained (each test uses fresh temp directory)
</success_criteria>

<output>
After completion, create `.planning/phases/01-data-foundation/01-02-SUMMARY.md`
</output>
