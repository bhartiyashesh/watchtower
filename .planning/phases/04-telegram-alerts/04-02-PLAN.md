---
phase: 04-telegram-alerts
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - tests/test_telegram_alerter.py
autonomous: true
requirements: [TELE-01, TELE-02, TELE-03, TELE-04, TELE-05]

must_haves:
  truths:
    - "Stranger alert sends photo with caption when unrecognized person detected"
    - "Unlock alert sends photo with caption when known person unlocks door"
    - "Coalescing suppresses duplicate stranger alerts within 60 seconds"
    - "Coalescing suppresses duplicate unlock alerts within 60 seconds"
    - "Stranger and unlock coalescing use independent timestamps"
    - "RetryAfter exception triggers one retry after sleeping the specified duration"
    - "TelegramError is caught and logged without crashing"
    - "Missing thumbnail falls back to text-only message"
    - "Alerter set to None when token/chat_id not configured"
    - "Pipeline alert dispatch fires after EventStore write"
  artifacts:
    - path: "tests/test_telegram_alerter.py"
      provides: "Comprehensive test suite for TelegramAlerter and pipeline integration"
      min_lines: 150
  key_links:
    - from: "tests/test_telegram_alerter.py"
      to: "telegram_alerter.py"
      via: "Unit tests import and exercise TelegramAlerter with mocked ExtBot"
      pattern: "from telegram_alerter import TelegramAlerter"
    - from: "tests/test_telegram_alerter.py"
      to: "main.py"
      via: "Integration tests verify alert dispatch logic in polling_loop context"
      pattern: "alert_stranger|alert_unlock"
---

<objective>
Create a comprehensive test suite validating all five TELE requirements: stranger alerts, unlock confirmations, photo+caption in single message, 60-second coalescing, and AIORateLimiter rate control.

Purpose: Proves the Telegram alerter implementation satisfies every acceptance criterion with automated, repeatable tests. Tests use mocked ExtBot (no real Telegram API calls) to validate behavior in isolation.

Output: `tests/test_telegram_alerter.py` with 10-12 tests covering all TELE requirements plus edge cases.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/STATE.md
@.planning/phases/04-telegram-alerts/04-RESEARCH.md
@.planning/phases/04-telegram-alerts/04-01-SUMMARY.md
@telegram_alerter.py
@main.py
@app.py
@config.py
@tests/test_pipeline.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TelegramAlerter unit tests</name>
  <files>tests/test_telegram_alerter.py</files>
  <action>
Create `tests/test_telegram_alerter.py` with pytest + pytest-asyncio tests. All tests use `unittest.mock.AsyncMock` to mock `ExtBot` — no real Telegram API calls.

**Test fixtures:**

- `mock_bot` fixture: Creates an `AsyncMock` spec'd to `ExtBot`. Set `mock_bot.send_photo = AsyncMock()` and `mock_bot.send_message = AsyncMock()` and `mock_bot.initialize = AsyncMock()` and `mock_bot.shutdown = AsyncMock()` and `mock_bot.get_chat = AsyncMock()`.
- `alerter` fixture: Creates a `TelegramAlerter` instance, then patches `alerter._bot` with the `mock_bot` fixture. This avoids needing a real token. Set `alerter._chat_id = "test_chat_123"`.
- `tmp_thumbnail` fixture: Creates a temporary JPEG file using `PIL.Image` (100x100 red image) saved to a temp directory. Yields the file path. Cleans up after test.

**Tests to write (each @pytest.mark.asyncio):**

1. **test_alert_stranger_sends_photo_with_caption** (TELE-01, TELE-03):
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Unknown person at door")`.
   - Assert `mock_bot.send_photo.assert_called_once()`.
   - Extract the call kwargs: verify `chat_id` matches, `caption` matches "Unknown person at door", and `photo` argument is a file handle (not None).
   - Assert `mock_bot.send_message` was NOT called (single send_photo call, not separate text).

2. **test_alert_unlock_sends_photo_with_caption** (TELE-02, TELE-03):
   - Call `await alerter.alert_unlock(tmp_thumbnail, "Welcome home, Alice!")`.
   - Assert `mock_bot.send_photo.assert_called_once()`.
   - Verify caption matches. Assert `mock_bot.send_message` was NOT called.

3. **test_stranger_coalescing_suppresses_within_60s** (TELE-04):
   - Call `await alerter.alert_stranger(tmp_thumbnail, "First alert")` — should send.
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Second alert")` — should be suppressed.
   - Assert `mock_bot.send_photo.call_count == 1` (only first alert sent).

4. **test_stranger_coalescing_allows_after_60s** (TELE-04):
   - Call `await alerter.alert_stranger(tmp_thumbnail, "First alert")`.
   - Manually set `alerter._last_stranger_alert = time.monotonic() - 61` (simulate 61 seconds elapsed).
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Second alert")`.
   - Assert `mock_bot.send_photo.call_count == 2` (both sent).

5. **test_unlock_coalescing_suppresses_within_60s** (TELE-04):
   - Same pattern as test 3 but for `alert_unlock`. Assert only 1 send_photo call.

6. **test_stranger_and_unlock_coalescing_independent** (TELE-04):
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Stranger")` — sends.
   - Immediately call `await alerter.alert_unlock(tmp_thumbnail, "Unlock")` — should also send (different timestamp).
   - Assert `mock_bot.send_photo.call_count == 2` (both sent — independent coalescing).

7. **test_rate_limiter_configured** (TELE-05):
   - Create a fresh `TelegramAlerter(token="test", chat_id="123")`.
   - Assert `alerter._bot._rate_limiter is not None` — verifies AIORateLimiter was passed to ExtBot constructor.
   - Note: This tests that the constructor wires the rate limiter. The actual rate limiting behavior is tested by PTB internally.

8. **test_retry_after_exception_retries_once** (TELE-05):
   - Import `RetryAfter` from `telegram.error`.
   - Configure `mock_bot.send_photo` to raise `RetryAfter(1)` on first call and succeed on second call using `side_effect=[RetryAfter(1), None]`.
   - Patch `asyncio.sleep` as an AsyncMock.
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Test")`.
   - Assert `mock_bot.send_photo.call_count == 2` (one retry).
   - Assert `asyncio.sleep` was called with approximately 1 second.

9. **test_telegram_error_does_not_crash** (robustness):
   - Import `TelegramError` from `telegram.error`.
   - Configure `mock_bot.send_photo` to raise `TelegramError("API unavailable")`.
   - Call `await alerter.alert_stranger(tmp_thumbnail, "Test")` — should NOT raise.
   - No assertion on return value — just verify it does not propagate the exception.

10. **test_missing_thumbnail_falls_back_to_text** (TELE-03 edge case):
    - Call `await alerter.alert_stranger("/nonexistent/path.jpg", "Stranger detected")`.
    - Assert `mock_bot.send_message.assert_called_once()` (text fallback).
    - Assert `mock_bot.send_photo` was NOT called.

11. **test_none_thumbnail_falls_back_to_text** (TELE-03 edge case):
    - Call `await alerter.alert_stranger(None, "Stranger detected")`.
    - Assert `mock_bot.send_message.assert_called_once()`.
    - Assert `mock_bot.send_photo` was NOT called.

12. **test_initialize_validates_chat_reachability** (startup):
    - Call `await alerter.initialize()`.
    - Assert `mock_bot.initialize.assert_called_once()`.
    - Assert `mock_bot.get_chat.assert_called_once_with(chat_id="test_chat_123")`.

Follow project conventions:
- Use `@pytest.mark.asyncio` on all async tests.
- Use `assert` statements (not unittest assertions).
- Each test is independent (isolated alerter + mock_bot per test via fixtures).
- Logger name: match project pattern `logging.getLogger("smart-lock.telegram")`.
  </action>
  <verify>
    <automated>cd /Users/yasheshbharti/Documents/experiments/Ring-Auth/files/smart-lock-system && python -m pytest tests/test_telegram_alerter.py -v --tb=short 2>&1 | tail -30</automated>
    <manual>Verify all 12 tests pass. Check that no test makes real Telegram API calls (all use mocked ExtBot).</manual>
  </verify>
  <done>tests/test_telegram_alerter.py exists with 12 passing tests covering: stranger alert sends photo+caption (TELE-01, TELE-03), unlock alert sends photo+caption (TELE-02, TELE-03), coalescing suppresses duplicates within 60s (TELE-04), coalescing allows after 60s (TELE-04), stranger/unlock coalescing is independent (TELE-04), rate limiter configured on ExtBot (TELE-05), RetryAfter triggers retry (TELE-05), TelegramError does not crash (robustness), missing/None thumbnail falls back to text, initialize validates chat. All tests use mocked ExtBot with no real API calls. Total test count across project is ~52 (40 existing + 12 new).</done>
</task>

</tasks>

<verification>
1. `python -m pytest tests/test_telegram_alerter.py -v` — all 12 tests pass
2. `python -m pytest tests/ -v` — all project tests pass (no regressions in existing 40 tests)
3. `grep -c 'def test_' tests/test_telegram_alerter.py` returns 12
4. `grep -c 'send_photo' tests/test_telegram_alerter.py` returns >= 5 (photo sending is the core behavior)
5. No real Telegram API calls in tests (all ExtBot methods are AsyncMock)
</verification>

<success_criteria>
- 12 tests in test_telegram_alerter.py all passing
- Every TELE requirement (TELE-01 through TELE-05) has at least one dedicated test
- Coalescing tested for both suppression and allow-after-timeout scenarios
- Stranger and unlock coalescing proven independent
- RetryAfter retry proven with mock side_effect
- Error resilience proven (TelegramError does not propagate)
- Thumbnail fallback proven (missing file and None both produce text message)
- No regressions in existing test suite (40 tests from Phases 1-3)
</success_criteria>

<output>
After completion, create `.planning/phases/04-telegram-alerts/04-02-SUMMARY.md`
</output>
